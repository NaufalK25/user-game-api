name: Main
on:
    push:
        branches: [main]
    workflow_dispatch:
jobs:
    build:
        runs-on: ubuntu-latest
        env:
            BASE_URL: ${{secrets.BASE_URL}}
            HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
            HEROKU_APP_NAME: ${{secrets.HEROKU_APP_NAME}}
            HEROKU_EMAIL: ${{secrets.HEROKU_EMAIL}}
            NODE_ENV: ${{secrets.NODE_ENV}}
            PGSSLMODE: ${{secrets.PGSSLMODE}}
            PORT: ${{secrets.PORT}}
            PROD_DB_DIALECT: ${{ secrets.DB_DIALECT }}
            PROD_DB_USER: ${{ secrets.DB_USER }}
            PROD_DB_PASS: ${{ secrets.DB_PASS }}
            PROD_DB_NAME: ${{ secrets.DB_NAME }}
            PROD_DB_HOST: ${{ secrets.DB_HOST }}
        steps:
            - uses: actions/checkout@v2
            - name: Use Node.js
              uses: actions/setup-node@v2
              with:
                  node-version: "14.x"
            - name: Install yarn
              uses: sergioramos/yarn-actions/install@v6
              with:
                  frozen-lockfile: true
            - name: Install dependencies
              run: yarn

    deploy:
        runs-on: ubuntu-latest
        needs: [build]
        steps:
            - uses: actions/checkout@v2
            - uses: akhileshns/heroku-deploy@v3.12.12
              with:
                  heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
                  heroku_app_name: ${{ secrets.HEROKU_APP_NAME }}
                  heroku_email: ${{ secrets.HEROKU_EMAIL }}
